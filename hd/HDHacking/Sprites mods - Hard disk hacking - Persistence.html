<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<title>Sprites mods - Hard disk hacking - Persistence</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<link rel="stylesheet" type="text/css" href="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/style-new.css">
<link rel="stylesheet" type="text/css" href="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/print.css" media="print">
<link type="application/rss+xml" rel="alternate" title="Sprites Mods" href="http://spritesmods.com/rss.php">
<script src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/ca-pub-6055011648930388.js" type="text/javascript" async=""></script><script id="COINWIDGETCOM_JQUERY" src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/jquery.js"></script><link href="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/coin.css" type="text/css" rel="stylesheet" id="COINWIDGETCOM_STYLESHEET"><script id="COINWIDGETCOM_INFO0.34142209563223647" src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/lookup.php"></script></head>
<body>

<div id="header"><span id="sitename"><span id="sitenamebig">SpritesMods</span>.com</span><h1>Hard disk hacking - Persistence</h1></div>


<div id="left">
<p>
<a href="http://spritesmods.com/?art=main">Welcome</a><br></p><ul id="mainmenu"><li><a href="http://spritesmods.com/?art=hardware">Hardware stuff</a></li><li><a href="http://spritesmods.com/?art=hacks">Hacks</a><ul id="submenu"><li><a href="http://spritesmods.com/?art=vpx500">Hacking the VPx500</a></li><li><a href="http://spritesmods.com/?art=hddhack">Hard disk hacking</a></li><li><a href="http://spritesmods.com/?art=zx3hack">Hacking the Kodak Zx3</a></li><li><a href="http://spritesmods.com/?art=rtl8366sb">Dumb to managed switch conversion</a></li><li><a href="http://spritesmods.com/?art=rapidisnake">Snake on a Keyboard</a></li><li><a href="http://spritesmods.com/?art=twitter1943">Twittering vintage arcade game</a></li><li><a href="http://spritesmods.com/?art=ledbl">LEDs replacing CCFL backlight</a></li><li><a href="http://spritesmods.com/?art=keybled">Laptop keyboard LED</a></li><li><a href="http://spritesmods.com/?art=wskpsip">Convert a SMC WSKP100 to use SIP</a></li><li><a href="http://spritesmods.com/?art=mouseeye">Optical mouse-cam</a></li><li><a href="http://spritesmods.com/?art=picframe">Use a cheap digital photoframe as a second display for your PC</a></li><li><a href="http://spritesmods.com/?art=sweexusb">Add USB to a Sweex LB000021 router</a></li><li><a href="http://spritesmods.com/?art=ljdisplay">Standalone HPLJ display hack</a></li><li><a href="http://spritesmods.com/?art=swordfish">Damocles' Swordfish</a></li><li><a href="http://spritesmods.com/?art=wtcluster">Cluster using WT-300s</a></li></ul></li><li><a href="http://spritesmods.com/?art=consoles">Console hacking</a></li><li><a href="http://spritesmods.com/?art=security">Security</a></li><li><a href="http://spritesmods.com/?art=software">Software</a></li><li><a href="http://spritesmods.com/?art=nabaztag">Nabaztag</a></li><li><a href="http://spritesmods.com/?art=about">About Spritesmods</a></li></ul></div>

<div id="right">
<div id="righttop">
<p><a href="http://spritesmods.com/?art=hddhack&amp;page=1"><strong>Page 1</strong><br></a>Intro</p><p><a href="http://spritesmods.com/?art=hddhack&amp;page=2"><strong>Page 2</strong><br></a>Parts on the PCB</p><p><a href="http://spritesmods.com/?art=hddhack&amp;page=3"><strong>Page 3</strong><br></a>Hooking up JTAG</p><p><a href="http://spritesmods.com/?art=hddhack&amp;page=4"><strong>Page 4</strong><br></a>Injecting code</p><p><strong>Page 5</strong><br>Persistence</p><p><a href="http://spritesmods.com/?art=hddhack&amp;page=6"><strong>Page 6</strong><br></a>Software flashing</p><p><a href="http://spritesmods.com/?art=hddhack&amp;page=7"><strong>Page 7</strong><br></a>Other uses</p><p><a href="http://spritesmods.com/?art=hddhack&amp;page=8"><strong>Page 8</strong><br></a>Conclusion (+ discussion / remarks)</p><p>
</p>
</div>
<div id="rightbottom">
<p>
Do you like my hacking? If so, please consider leaving something in the<br>
</p>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input name="cmd" value="_donations" type="hidden">
<input name="business" value="AWHK8LYRDDS3C" type="hidden">
<input name="lc" value="GB" type="hidden">
<input name="item_name" value="Spritesmods.com" type="hidden">
<input name="no_note" value="0" type="hidden">
<input name="cn" value="Remarks" type="hidden">
<input name="no_shipping" value="1" type="hidden">
<input name="rm" value="1" type="hidden">
<input name="return" value="http://spritesmods.com/?art=main&amp;thanks=1" type="hidden">
<input name="currency_code" value="EUR" type="hidden">
<input name="bn" value="PP-DonationsBF:donate.png:NonHosted" type="hidden">
<input src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/donate.png" name="submit" alt="PayPal, de veilige en complete manier van online betalen." border="0" type="image">
<!--
<img alt="" border="0" src="https://www.paypalobjects.com/nl_NL/i/scr/pixel.gif" width="1" height="1">
-->
</form>

<p>
Or use Bitcoins:<br>
<script src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/coin.js"></script>
<script>
CoinWidgetCom.go({
	wallet_address: "16wKm29FmTLmYSrDtBXB4zLYGsqfrTwcEC"
	, currency: "bitcoin"
	, counter: "count"
	, alignment: "bl"
	, qrcode: true
	, auto_show: false
	, lbl_button: "Donate"
	, lbl_address: "My Bitcoin Address:"
	, lbl_count: "donations"
	, lbl_amount: "BTC"
});
</script><span data-coinwidget-instance="0" class="COINWIDGETCOM_CONTAINER"><a class="COINWIDGETCOM_BUTTON_BITCOIN" href="#"><img src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/icon_bitcoin.png"><span>Donate</span></a><span>0</span></span>
</p>


<p>
<br>Current contents:
<br>EUR282 (about $375.06) and a bunch of cool hardware.
</p>


<p>
Follow Spritesmods on <a href="http://twitter.com/SpritesMods">Twitter</a>!
</p>
</div>
</div>
<div id="center">
<p></p><h1>Persistence
</h1>
<p></p>
<!-- google_ad_section_start -->
<p>
Ofcourse, I could make this into a full hack, but needing to use
JTAG to poke it in RAM every time the hard disk boots would make it
pretty useless. I needed to make it persistant, that is, I needed to
store my modifications somewhere where it would be picked up again 
every time the hard disk powers on.
</p>
<p>
My location of choice was the flash rom. I could probably also have put
it somewhere in the reserved sectors on the disk itself, but if I messed
something up, I would have no way to recover my disk. The flash chip
is just an eight-pin standard part, so I could easily take it out, flash
it and put it in again. For that purpose, I desoldered it and put it
on a bit of veroboard, so I could easily switch it between a programmer
and the hard disk:<br>
<a href="http://meuk.spritesserver.nl/foto/foto/hdhack/IMG_2106.JPG"><img src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/tmb-IMG_2106.JPG"></a>
</p>
<p>
Now, what to put in the flash? Luckily, the format of what's stored
in the chip already has <a href="http://nazyura.hardw.net/Part02.htm">been figured out</a>: it consists of multiple
blocks of data, with a table describing them at the very start. That
table describes the location of the block in flash, how it's compressed
(if it is compressed), the location where the block should be put
in RAM and, for the final address, an execution point where the loader
would jump to to start executing the program. 
</p>
<p>
Unfortunately, I couldn't modify the code that was in the flash; the bits 
that contained the parts where I wanted to put my hooks was compressed with
an unknown compression algorithm, so I couldn't modify that. What I however
could do was add an extra block, and modify the execution address so that 
block would get executed before the rest. That made things a bit easier:
when 'my' block got executed, I could just code it to insert the hooks in the
now decompressed bits of code.
</p>
<p>
Ofcourse, I had to dis- and re-assemble the flash binary for this. I created a
tool for that, unimaginatively called 'fwtool'. This tool can dump out the 
various blocks in the flash, plus translate the header into a text file for easy
modification. You can then modify, delete or add a block and re-assemble 
everything into a single firmware file, ready to be re-flashed. I used that to
add my custom bit of code to the image, flashed everything back to the chip,
put the chip back into the HD, booted everything back up and this was the
result:<br>
<a href="http://meuk.spritesserver.nl/foto/foto/hdhack/1sthack_2.png">
<img src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/tmb-1sthack_2.png"></a>
</p>
<p>
The result isn't that shocking: it's exactly the same as I had before. The trick is
that I didn't need the JTAG-rig to get it.
</p>
<!-- google_ad_section_end -->
<p>	<script async="" src="Sprites%20mods%20-%20Hard%20disk%20hacking%20-%20Persistence_files/adsbygoogle.js"></script>
	<!-- singlebigad -->
	<ins data-adsbygoogle-status="done" class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-6055011648930388" data-ad-slot="3668631373"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;" frameborder="0" height="90" width="728"></iframe></ins></ins></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	</p><p id="prevnext"><a href="http://spritesmods.com/?art=hddhack&amp;page=4">« Prev</a>&nbsp;5&nbsp;<a href="http://spritesmods.com/?art=hddhack&amp;page=6">Next »</a></p><br><div class="copy">© 2006-2014 Sprite_tm - <a href="http://spritesmods.com/?art=contact&amp;af=Hard%20disk%20hacking">Contact</a></div></div>


</body></html>